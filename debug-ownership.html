<!DOCTYPE html>
<html>
<head>
    <title>Debug Chat Ownership</title>
    <script src="https://unpkg.com/@nhost/nhost-js@latest"></script>
</head>
<body>
    <h1>Debug Chat Ownership</h1>
    <div>
        <button onclick="signIn()">1. Sign In</button>
        <button onclick="checkChats()">2. Check My Chats</button>
        <button onclick="createNewChat()">3. Create New Chat</button>
        <button onclick="testChatOwnership()">4. Test Chat Ownership</button>
    </div>
    <div id="result"></div>

    <script>
        // Initialize Nhost
        const nhost = new NhostClient({
            subdomain: 'wertssqowjrkykmeovsg',
            region: 'ap-south-1'
        });

        async function signIn() {
            const result = document.getElementById('result');
            result.innerHTML = 'Signing in...';
            
            try {
                const { session, error } = await nhost.auth.signIn({
                    email: 'test@example.com',
                    password: 'password123'
                });
                
                if (error) {
                    result.innerHTML = `<div style="color: red;">Sign in failed: ${error.message}</div>`;
                } else {
                    const user = nhost.auth.getUser();
                    result.innerHTML = `
                        <div style="color: green;">
                            ✅ Signed in successfully!<br>
                            <strong>User ID:</strong> ${user.id}<br>
                            <strong>Email:</strong> ${user.email}
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div style="color: red;">Sign in error: ${error.message}</div>`;
            }
        }

        async function checkChats() {
            const result = document.getElementById('result');
            result.innerHTML = 'Checking chats...';
            
            try {
                const accessToken = await nhost.auth.getAccessToken();
                const user = nhost.auth.getUser();
                
                if (!accessToken) {
                    result.innerHTML = '<div style="color: red;">Please sign in first!</div>';
                    return;
                }

                const response = await fetch('https://wertssqowjrkykmeovsg.hasura.ap-south-1.nhost.run/v1/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        query: `
                            query GetMyChats {
                                chats {
                                    id
                                    title
                                    user_id
                                    created_at
                                }
                            }
                        `
                    })
                });
                
                const data = await response.json();
                console.log('Chats response:', data);
                
                if (data.errors) {
                    result.innerHTML = `<div style="color: red;">Error: ${JSON.stringify(data.errors, null, 2)}</div>`;
                } else {
                    const chats = data.data.chats || [];
                    result.innerHTML = `
                        <div>
                            <h3>Your Chats (User ID: ${user?.id}):</h3>
                            ${chats.length === 0 ? 
                                '<p style="color: orange;">No chats found. Create a new chat first!</p>' :
                                chats.map(chat => `
                                    <div style="border: 1px solid #ccc; margin: 5px; padding: 10px;">
                                        <strong>Chat ID:</strong> ${chat.id}<br>
                                        <strong>Title:</strong> ${chat.title}<br>
                                        <strong>Owner ID:</strong> ${chat.user_id}<br>
                                        <strong>Match:</strong> ${chat.user_id === user?.id ? '✅ You own this' : '❌ Not yours'}<br>
                                        <strong>Created:</strong> ${new Date(chat.created_at).toLocaleString()}
                                    </div>
                                `).join('')
                            }
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        async function createNewChat() {
            const result = document.getElementById('result');
            result.innerHTML = 'Creating new chat...';
            
            try {
                const accessToken = await nhost.auth.getAccessToken();
                
                if (!accessToken) {
                    result.innerHTML = '<div style="color: red;">Please sign in first!</div>';
                    return;
                }

                const response = await fetch('https://wertssqowjrkykmeovsg.hasura.ap-south-1.nhost.run/v1/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        query: `
                            mutation CreateNewChat($title: String!) {
                                insert_chats_one(object: { title: $title }) {
                                    id
                                    title
                                    user_id
                                    created_at
                                }
                            }
                        `,
                        variables: {
                            title: "Debug Test Chat"
                        }
                    })
                });
                
                const data = await response.json();
                console.log('Create chat response:', data);
                
                if (data.errors) {
                    result.innerHTML = `<div style="color: red;">Error: ${JSON.stringify(data.errors, null, 2)}</div>`;
                } else {
                    const chat = data.data.insert_chats_one;
                    result.innerHTML = `
                        <div style="color: green;">
                            ✅ New chat created!<br>
                            <strong>Chat ID:</strong> ${chat.id}<br>
                            <strong>Title:</strong> ${chat.title}<br>
                            <strong>Owner ID:</strong> ${chat.user_id}<br>
                            <strong>Created:</strong> ${new Date(chat.created_at).toLocaleString()}<br>
                            <br>
                            <strong>Use this Chat ID for testing!</strong>
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        async function testChatOwnership() {
            const result = document.getElementById('result');
            const chatId = prompt('Enter the Chat ID to test ownership:');
            
            if (!chatId) return;
            
            result.innerHTML = 'Testing chat ownership...';
            
            try {
                const accessToken = await nhost.auth.getAccessToken();
                const user = nhost.auth.getUser();
                
                if (!accessToken) {
                    result.innerHTML = '<div style="color: red;">Please sign in first!</div>';
                    return;
                }

                const response = await fetch('https://wertssqowjrkykmeovsg.hasura.ap-south-1.nhost.run/v1/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        query: `
                            query CheckChatOwnership($chatId: uuid!, $userId: uuid!) {
                                chats_by_pk(id: $chatId) {
                                    id
                                    title
                                    user_id
                                }
                            }
                        `,
                        variables: {
                            chatId: chatId,
                            userId: user.id
                        }
                    })
                });
                
                const data = await response.json();
                console.log('Ownership check response:', data);
                
                if (data.errors) {
                    result.innerHTML = `<div style="color: red;">Error: ${JSON.stringify(data.errors, null, 2)}</div>`;
                } else {
                    const chat = data.data.chats_by_pk;
                    if (!chat) {
                        result.innerHTML = `<div style="color: red;">❌ Chat not found: ${chatId}</div>`;
                    } else {
                        const ownsChat = chat.user_id === user.id;
                        result.innerHTML = `
                            <div style="color: ${ownsChat ? 'green' : 'red'};">
                                <h3>${ownsChat ? '✅ You own this chat!' : '❌ You do NOT own this chat'}</h3>
                                <strong>Chat ID:</strong> ${chat.id}<br>
                                <strong>Chat Title:</strong> ${chat.title}<br>
                                <strong>Chat Owner ID:</strong> ${chat.user_id}<br>
                                <strong>Your User ID:</strong> ${user.id}<br>
                                <strong>Match:</strong> ${ownsChat ? 'YES' : 'NO'}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                result.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
